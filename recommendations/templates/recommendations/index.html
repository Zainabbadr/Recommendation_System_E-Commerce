{% extends 'recommendations/base.html' %}

{% block content %}
<div class="container-fluid">
    <!-- Tab Navigation -->
    <ul class="nav nav-tabs" id="recommendationTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="ai-tab" data-bs-toggle="tab" data-bs-target="#ai-recommendations" 
                    type="button" role="tab" aria-controls="ai-recommendations" aria-selected="true">
                ðŸ¤– AI Recommendations
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual-recommendations" 
                    type="button" role="tab" aria-controls="manual-recommendations" aria-selected="false">
                ðŸ“Š Manual Recommendations
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content mt-3" id="recommendationTabContent">
        <!-- AI Recommendations Tab -->
        <div class="tab-pane fade show active" id="ai-recommendations" role="tabpanel" aria-labelledby="ai-tab">
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>ðŸ¤– AI-Powered Recommendations</h5>
                            <small class="text-muted">Using advanced machine learning algorithms</small>
                        </div>
                        <div class="card-body">
                            <form method="post" id="ai-form">
                                {% csrf_token %}
                                <input type="hidden" name="recommendation_type" value="ai">
                                
                                <div class="mb-3">
                                    <label for="ai_target_user_id" class="form-label">Customer ID</label>
                                    <input type="number" class="form-control" id="ai_target_user_id" name="target_user_id" 
                                           value="{{ target_user_id|default:'17850' }}" required>
                                    <small class="form-text text-muted">Enter the customer ID to get AI recommendations for</small>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="ai_selected_products" class="form-label">Select Products</label>
                                    <select multiple class="form-control" id="ai_selected_products" name="selected_products" 
                                            size="8" required style="height: 200px;">
                                        {% for stock_code, description, price in available_products %}
                                            <option value="{{ stock_code }}" 
                                                {% if stock_code in valid_stock_codes %}selected{% endif %}>
                                                {{ description }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <small class="form-text text-muted">Hold Ctrl (Cmd on Mac) to select multiple products</small>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">ðŸš€ Get AI Recommendations</button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    {% if recommendations and recommendation_type == 'ai' %}
                    <div class="card">
                        <div class="card-header">
                            <h5>ðŸ¤– AI Recommendations for Customer {{ target_user_id }}</h5>
                            <small class="text-muted">Source: {{ recommendation_source|default:'AI Algorithm' }}</small>
                        </div>
                        <div class="card-body">
                            <!-- Show selected products -->
                            {% if selected_products %}
                            <div class="mb-3">
                                <h6>ðŸ“¦ Based on selected products:</h6>
                                <ul class="list-unstyled">
                                    {% for product in selected_products %}
                                    <li><small><strong>{{ product.stock_code }}:</strong> {{ product.description }}</small></li>
                                    {% endfor %}
                                </ul>
                            </div>
                            <hr>
                            {% endif %}
                            
                            {% for rec in recommendations %}
                            <div class="recommendation-card">
                                <div>
                                    <h6 class="mb-1">{{ rec.description }}</h6>
                                    <p class="mb-1"><strong>Stock Code:</strong> {{ rec.stock_code }}</p>
                                    <p class="mb-1"><strong>Price:</strong> ${{ rec.unit_price }}</p>
                                    {% if rec.confidence %}
                                    <p class="mb-1"><strong>Confidence:</strong> {{ rec.confidence|floatformat:2 }}%</p>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% else %}
                    <div class="card">
                        <div class="card-body text-center text-muted">
                            <h5>ðŸ¤– AI Recommendations</h5>
                            <p>Select products and get AI-powered recommendations!</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            {% if error and recommendation_type == 'ai' %}
            <div class="alert alert-warning mt-3">
                <strong>AI System Notice:</strong> {{ error }}
                <br><small>Falling back to manual recommendations...</small>
            </div>
            {% endif %}
        </div>

        <!-- Manual Recommendations Tab -->
        <div class="tab-pane fade" id="manual-recommendations" role="tabpanel" aria-labelledby="manual-tab">
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>ðŸ“Š Manual Algorithm Recommendations</h5>
                            <small class="text-muted">Using traditional collaborative filtering</small>
                        </div>
                        <div class="card-body">
                            <form method="post" id="manual-form">
                                {% csrf_token %}
                                <input type="hidden" name="recommendation_type" value="manual">
                                
                                <div class="mb-3">
                                    <label for="manual_target_user_id" class="form-label">Customer ID</label>
                                    <input type="number" class="form-control" id="manual_target_user_id" name="target_user_id" 
                                           value="{{ target_user_id|default:'17850' }}" required>
                                    <small class="form-text text-muted">Enter the customer ID to get manual recommendations for</small>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="manual_selected_products" class="form-label">Select Products</label>
                                    <select multiple class="form-control" id="manual_selected_products" name="selected_products" 
                                            size="8" required style="height: 200px;">
                                        {% for stock_code, description, price in available_products %}
                                            <option value="{{ stock_code }}" 
                                                {% if stock_code in valid_stock_codes %}selected{% endif %}>
                                                {{ description }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <small class="form-text text-muted">Hold Ctrl (Cmd on Mac) to select multiple products</small>
                                </div>
                                
                                <button type="submit" class="btn btn-success">ðŸ“Š Get Manual Recommendations</button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    {% if recommendations and recommendation_type == 'manual' %}
                    <div class="card">
                        <div class="card-header">
                            <h5>ðŸ“Š Manual Recommendations for Customer {{ target_user_id }}</h5>
                            <small class="text-muted">Source: {{ recommendation_source|default:'Manual Algorithm' }}</small>
                        </div>
                        <div class="card-body">
                            <!-- Show selected products -->
                            {% if selected_products %}
                            <div class="mb-3">
                                <h6>ðŸ“¦ Based on selected products:</h6>
                                <ul class="list-unstyled">
                                    {% for product in selected_products %}
                                    <li><small><strong>{{ product.stock_code }}:</strong> {{ product.description }}</small></li>
                                    {% endfor %}
                                </ul>
                            </div>
                            <hr>
                            {% endif %}
                            
                            {% for rec in recommendations %}
                            <div class="recommendation-card">
                                <div>
                                    <h6 class="mb-1">{{ rec.description }}</h6>
                                    <p class="mb-1"><strong>Stock Code:</strong> {{ rec.stock_code }}</p>
                                    <p class="mb-1"><strong>Price:</strong> ${{ rec.unit_price }}</p>
                                    {% if rec.score %}
                                    <p class="mb-1"><strong>Score:</strong> {{ rec.score|floatformat:3 }}</p>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% else %}
                    <div class="card">
                        <div class="card-body text-center text-muted">
                            <h5>ðŸ“Š Manual Recommendations</h5>
                            <p>Select products and get algorithm-based recommendations!</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            {% if error and recommendation_type == 'manual' %}
            <div class="alert alert-danger mt-3">
                <strong>Error:</strong> {{ error }}
                
                {% if available_customers %}
                <hr>
                <strong>Available Customer IDs (sample):</strong>
                <br>{{ available_customers|join:', ' }}
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Synchronize form inputs between tabs
document.addEventListener('DOMContentLoaded', function() {
    // Get all input elements
    const aiUserId = document.getElementById('ai_target_user_id');
    const manualUserId = document.getElementById('manual_target_user_id');
    const aiProducts = document.getElementById('ai_selected_products');
    const manualProducts = document.getElementById('manual_selected_products');
    
    // Sync user ID inputs
    aiUserId.addEventListener('input', function() {
        manualUserId.value = this.value;
    });
    
    manualUserId.addEventListener('input', function() {
        aiUserId.value = this.value;
    });
    
    // Sync product selections
    aiProducts.addEventListener('change', function() {
        // Get selected options from AI tab
        const selectedValues = Array.from(this.selectedOptions).map(option => option.value);
        
        // Clear manual tab selections
        Array.from(manualProducts.options).forEach(option => {
            option.selected = selectedValues.includes(option.value);
        });
    });
    
    manualProducts.addEventListener('change', function() {
        // Get selected options from Manual tab
        const selectedValues = Array.from(this.selectedOptions).map(option => option.value);
        
        // Clear AI tab selections
        Array.from(aiProducts.options).forEach(option => {
            option.selected = selectedValues.includes(option.value);
        });
    });
    
    // Handle tab switching based on recommendation type
    var recommendationType = '{{ recommendation_type|default:"" }}';
    if (recommendationType === 'manual') {
        // Switch to manual tab if manual recommendations were requested
        const manualTab = new bootstrap.Tab(document.getElementById('manual-tab'));
        manualTab.show();
    }
});
</script>
{% endblock %}