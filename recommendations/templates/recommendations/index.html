{% extends 'recommendations/base.html' %}

{% block content %}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Arial', -apple-system, BlinkMacSystemFont, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
    }

    /* Modern Navbar */
    .navbar {
        background: rgba(255, 255, 255, 0.95) !important;
        backdrop-filter: blur(20px);
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .navbar-brand {
        color: #2c3e50 !important;
        font-weight: 700;
        font-size: 1.5rem;
    }

    /* Main Container */
    .main-container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        margin: 2rem;
        padding: 2rem;
    }

    /* Modern Tabs */
    .nav-tabs {
        border: none;
        background: #f8f9fa;
        border-radius: 15px;
        padding: 0.5rem;
        margin-bottom: 2rem;
    }

    .nav-tabs .nav-link {
        border: none;
        border-radius: 10px;
        padding: 12px 24px;
        font-weight: 600;
        color: #6c757d;
        transition: all 0.3s ease;
        margin: 0 4px;
    }

    .nav-tabs .nav-link.active {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .nav-tabs .nav-link:hover {
        color: #495057;
        transform: translateY(-2px);
    }

    /* Cards */
    .card {
        border: none;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }

    .card-header {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-bottom: 1px solid #dee2e6;
        border-radius: 16px 16px 0 0 !important;
        padding: 1.5rem;
    }

    /* Chat Interface */
    #chat-container {
        background: linear-gradient(135deg, #fafbfc, #f1f3f4);
        border-radius: 12px;
        height: 500px;
        overflow-y: auto;
        padding: 20px;
        border: 1px solid #e9ecef;
    }

    .message-bubble {
        max-width: 80%;
        word-wrap: break-word;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border-radius: 18px;
    }

    .bot-message .message-bubble {
        background: linear-gradient(135deg, #e3f2fd, #f3e5f5) !important;
        border: 1px solid #e1f5fe;
    }

    .user-message .message-bubble {
        background: linear-gradient(135deg, #667eea, #764ba2) !important;
        color: white;
    }

    .avatar {
        font-size: 24px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    /* Buttons */
    .btn {
        border-radius: 10px;
        padding: 12px 24px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea, #764ba2);
        border: none;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
    }

    .btn-warning {
        background: linear-gradient(135deg, #ffd93d, #ff6b6b);
        border: none;
        color: white;
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
    }

    /* Form Controls */
    .form-control, .form-select {
        border-radius: 10px;
        border: 2px solid #e9ecef;
        padding: 12px 16px;
        transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    /* Recommendation Cards */
    .recommendation-card {
        border: 1px solid #e9ecef;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        background: linear-gradient(135deg, #f8f9fa, #ffffff);
        transition: all 0.3s ease;
    }

    .recommendation-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    /* Alerts */
    .alert {
        border: none;
        border-radius: 12px;
        padding: 20px;
    }

    .alert-info {
        background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
        color: #1565c0;
    }

    /* Loading Animation */
    .typing-indicator {
        display: none;
    }

    .typing-indicator.show {
        display: block;
    }

    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
    }

    /* Typing dots animation */
    .typing-dots {
        display: inline-flex;
        align-items: center;
    }

    .typing-dots span {
        height: 8px;
        width: 8px;
        background-color: #6c757d;
        border-radius: 50%;
        display: inline-block;
        margin: 0 2px;
        animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dots span:nth-child(1) {
        animation-delay: -0.32s;
    }

    .typing-dots span:nth-child(2) {
        animation-delay: -0.16s;
    }

    @keyframes typing {
        0%, 80%, 100% {
            transform: scale(0.8);
            opacity: 0.5;
        }
        40% {
            transform: scale(1);
            opacity: 1;
        }
    }

    /* Interactive Elements */
    .example-query {
        cursor: pointer;
        color: #667eea !important;
        transition: all 0.3s ease;
        padding: 2px 6px;
        border-radius: 6px;
    }

    .example-query:hover {
        background: rgba(102, 126, 234, 0.1);
        text-decoration: none !important;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .main-container {
            margin: 1rem;
            padding: 1rem;
        }
        
        #chat-container {
            height: 400px;
        }
    }

    /* Animations */
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .tab-content {
        animation: slideIn 0.5s ease;
    }

    /*  Chat History Sidebar */

/* Chat History Sidebar */
.chat-history-sidebar {
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(20px);
    border-radius: 16px;
    padding: 0;
    height: 600px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transition: width 0.3s ease;
    position: relative;
}

.chat-history-sidebar.collapsed {
    width: 50px;
    min-width: 50px;
}

.sidebar-toggle-btn {
    position: absolute;
    top: 10px;
    right: -15px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.sidebar-toggle-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
}

.chat-history-sidebar.collapsed .sidebar-toggle-btn i {
    transform: rotate(180deg);
}

.sidebar-content {
    padding: 1rem;
    transition: opacity 0.3s ease;
    flex: 1;
    display: flex;
    flex-direction: column;
}

.chat-history-sidebar.collapsed .sidebar-content {
    opacity: 0;
    pointer-events: none;
}

.chat-history-header {
    border-bottom: 1px solid #e9ecef;
    padding-bottom: 1rem;
    margin-bottom: 1rem;
}

.chat-history-header h5 {
    color: #2c3e50;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.chat-count-badge {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.7rem;
    font-weight: 600;
}

.chat-search {
    margin-bottom: 1rem;
}

.new-chat-btn {
    width: 100%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 12px 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.new-chat-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.chat-management-options {
    padding: 0.5rem 0;
    border-top: 1px solid #f1f3f4;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chat-item {
    background: rgba(248, 249, 250, 0.8);
    border: 1px solid #e9ecef;
    border-radius: 12px;
    margin-bottom: 0.75rem;
    padding: 0.75rem;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.chat-item:hover {
    background: rgba(102, 126, 234, 0.1);
    border-color: #667eea;
    transform: translateX(2px);
}

.chat-item.active {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15));
    border-color: #667eea;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
}

.chat-item.active::before {
    content: '';
    position: absolute;
    left: -4px;
    top: 50%;
    transform: translateY(-50%);
    width: 4px;
    height: 70%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 0 4px 4px 0;
}

.chat-name {
    font-weight: 600;
    color: #2c3e50;
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chat-preview {
    font-size: 0.8rem;
    color: #6c757d;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    line-height: 1.4;
}

.chat-date {
    font-size: 0.7rem;
    color: #adb5bd;
    margin-top: 0.25rem;
    display: flex;
    align-items: center;
}

.chat-date i {
    margin-right: 4px;
    font-size: 0.6rem;
}

#chat-history-list {
    flex: 1;
    overflow-y: auto;
    padding-right: 5px;
}

#chat-history-list::-webkit-scrollbar {
    width: 6px;
}

#chat-history-list::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

#chat-history-list::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

#chat-history-list::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

.empty-state {
    text-align: center;
    padding: 2rem 1rem;
    color: #6c757d;
}

.empty-state i {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.chat-delete-btn {
    opacity: 0;
    transition: opacity 0.3s ease;
    background: none;
    border: none;
    color: #dc3545;
    cursor: pointer;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.7rem;
}

.chat-item:hover .chat-delete-btn {
    opacity: 1;
}

.chat-delete-btn:hover {
    background: rgba(220, 53, 69, 0.1);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .chat-history-sidebar {
        position: fixed;
        left: -300px;
        top: 0;
        height: 100vh;
        width: 300px;
        z-index: 1000;
        transition: left 0.3s ease;
    }
    
    .chat-history-sidebar.mobile-open {
        left: 0;
    }
    
    .chat-history-sidebar.collapsed {
        left: -300px;
    }
}

    /* User info bar */
   .user-info-bar {
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        border-radius: 15px;
        padding: 1rem 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .user-actions {
        display: flex;
        gap: 0.75rem;
        align-items: center;
    }

    .dashboard-btn {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        text-decoration: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .dashboard-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        color: white;
        text-decoration: none;
    }

    .logout-btn {
        background: linear-gradient(135deg, #dc3545, #c82333);
        color: white;
        text-decoration: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .logout-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
        color: white;
        text-decoration: none;
    }

    .login-prompt {
        background: linear-gradient(135deg, #ffc107, #fd7e14);
        color: #212529;
        text-decoration: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .login-prompt:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 193, 7, 0.4);
        color: #212529;
        text-decoration: none;
    }


     /* Product selection checkboxes */
.product-checkbox-container {
    background: #fafbfc;
}

.product-checkbox-container .form-check {
    padding: 8px 12px;
    border-radius: 6px;
    transition: background-color 0.2s ease;
}

.product-checkbox-container .form-check:hover {
    background-color: rgba(102, 126, 234, 0.1);
}

.product-checkbox-container .form-check-input:checked + .form-check-label {
    color: #667eea;
    font-weight: 600;
}

.form-check-label {
    cursor: pointer;
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
</style>

<div class="main-container">

    <!-- User Info Bar -->
     <div class="user-info-bar">
        <div class="d-flex justify-content-between align-items-center">
            {% if customer_id %}
                <div>
                    <span class="text-muted">Welcome back,</span>
                    <strong class="text-primary">Customer ID: {{ customer_id }}</strong>
                </div>
                <div class="user-actions">
                    <a href="{% url 'recommendations:customer_dashboard' %}" class="dashboard-btn">
                        <i class="fas fa-chart-line"></i> View My Dashboard
                    </a>
                    <a href="{% url 'recommendations:logout' %}" class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </div>
            {% else %}
                <div>
                    <span class="text-muted">Get personalized recommendations and insights</span>
                </div>
                <div class="user-actions">
                    <a href="{% url 'recommendations:login' %}" class="login-prompt">
                        <i class="fas fa-sign-in-alt"></i> Login for Personalized Experience
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
    <!-- End User Info Bar -->

    <!-- Tab Navigation -->
    <ul class="nav nav-tabs" id="recommendationTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link{% if not request.GET.tab or request.GET.tab != 'ai-recommendations' %} active{% endif %}" 
                    id="chatbot-tab" data-bs-toggle="tab" data-bs-target="#chatbot-recommendations" 
                    type="button" role="tab" aria-controls="chatbot-recommendations" 
                    aria-selected="{% if not request.GET.tab or request.GET.tab != 'ai-recommendations' %}true{% else %}false{% endif %}">
                AI Chatbot
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link{% if request.GET.tab == 'ai-recommendations' %} active{% endif %}" 
                    id="ai-tab" data-bs-toggle="tab" data-bs-target="#ai-recommendations" 
                    type="button" role="tab" aria-controls="ai-recommendations" 
                    aria-selected="{% if request.GET.tab == 'ai-recommendations' %}true{% else %}false{% endif %}">
                AI Recommendations
            </button>
        </li>
    </ul>


    <!-- Tab Content -->
    <div class="tab-content" id="recommendationTabContent">
        
        <!-- AI Chatbot Tab -->
        <div class="tab-pane fade{% if not request.GET.tab or request.GET.tab != 'ai-recommendations' %} show active{% endif %}" 
             id="chatbot-recommendations" role="tabpanel" aria-labelledby="chatbot-tab">
            <div class="row">
                <!-- Chat History Sidebar -->
                <div class="col-md-3">
                    <div class="chat-history-sidebar" id="chat-history-sidebar">
                        <button class="sidebar-toggle-btn" id="sidebar-toggle-btn">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        
                        <div class="sidebar-content">
                            <div class="chat-history-header">
                                <h5>
                                    <i class="fas fa-history"></i>
                                    Chat History 
                                    <span class="chat-count-badge" id="chat-count-badge">0</span>
                                </h5>
                                <div class="chat-search">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        <input type="text" class="form-control" placeholder="Search chats..." id="chat-search-input">
                                    </div>
                                </div>
                                <button class="new-chat-btn" onclick="startNewChat()">
                                    <i class="fas fa-plus"></i> New Chat
                                </button>
                                <div class="chat-management-options">
                                    <small class="text-muted" id="chat-count">No chats yet</small>
                                    <div class="chat-actions">
                                        <button class="btn btn-sm btn-outline-danger" onclick="clearAllChats()" 
                                                title="Clear all chats" id="clear-chats-btn" disabled>
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="chat-history-list">
                                <div class="empty-state">
                                    <i class="fas fa-comments"></i>
                                    <div>No chat history yet</div>
                                    <small>Start a conversation to see your chat history</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Chat Interface -->
                <div class="col-md-9" id="chat-main-content">
                    <div class="card">
                        <div class="card-header">
                            <h5 id="current-chat-title">AI Recommendation Chatbot</h5>
                            <small class="text-muted">Ask me anything about customer recommendations, purchase history, or product insights!</small>
                        </div>
                        <div class="card-body p-0">
                            <!-- Chat Interface -->
                            <div id="chat-container">
                                <div id="chat-messages">
                                    <!-- Welcome message -->
                                    <div class="message bot-message mb-3">
                                        <div class="d-flex">
                                            <div class="avatar me-2"><i class="fas fa-robot"></i></div>
                                            <div class="message-content">
                                                <div class="message-bubble p-3">
                                                    <strong>AI Assistant:</strong><br>
                                                    Hello! I'm your AI-powered recommendation assistant. I can help you with:
                                                    <ul class="mt-2 mb-0">
                                                        <li><strong>Personalized recommendations</strong> for any customer</li>
                                                        <li><strong>Customer behavior analysis</strong> and purchase patterns</li>
                                                        <li><strong>Product insights</strong> and market trends</li>
                                                        <li><strong>Interactive conversations</strong> about your business data</li>
                                                    </ul>
                                                    <div class="mt-3">
                                                        <strong>Try asking:</strong><br>
                                                        <span class="example-query" onclick="fillExampleQuery('Recommend products for customer 12345')">"Recommend products for customer 12345"</span><br>
                                                        <span class="example-query" onclick="fillExampleQuery('What did customer 15311 buy recently?')">"What did customer 15311 buy recently?"</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Chat Input -->
                            <div class="chat-input-container p-3">
                                <div class="input-group">
                                    <input type="text" id="chat-input" class="form-control" 
                                           placeholder="Ask me about recommendations, customers, or products..." 
                                           autocomplete="off">
                                    <button id="send-button" class="btn btn-primary">
                                        <i class="fas fa-paper-plane"></i> Send
                                    </button>
                                </div>
                                <small class="text-muted mt-1 d-block">
                                    Tip: Be specific with customer IDs or product details for better recommendations
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Recommendations Tab -->
        <div class="tab-pane fade{% if request.GET.tab == 'ai-recommendations' %} show active{% endif %}" 
             id="ai-recommendations" role="tabpanel" aria-labelledby="ai-tab">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>AI Recommendations</h5>
                            <small class="text-muted">Advanced AI recommendations with automatic fallback to manual algorithms</small>
                        </div>
                        <div class="card-body">
                            <form method="post" action="{% url 'recommendations:index' %}">
                                {% csrf_token %}
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="target_user_id" class="form-label">
                                                <strong>Customer ID</strong>
                                            </label>
                                            {% if customer_id %}
                                                <input type="number" class="form-control" name="target_user_id" 
                                                    value="{{ customer_id }}" readonly 
                                                    style="background-color: #f8f9fa; cursor: not-allowed;">
                                                <div class="form-text">
                                                    Using your logged-in customer ID. <a href="{% url 'recommendations:logout' %}">Switch account?</a>
                                                </div>
                                            {% else %}
                                                <input type="number" class="form-control" name="target_user_id" 
                                                    value="{{ target_user_id|default:'' }}" 
                                                    placeholder="Enter customer ID (e.g., 12345)" required>
                                                <div class="form-text">
                                                    <a href="{% url 'recommendations:login' %}">Login</a> to auto-fill your customer ID.
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="selected_products" class="form-label">
                                                <strong>Select Products</strong> 
                                                <span class="text-danger">*</span>
                                            </label>
                                            <div class="product-checkbox-container" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; padding: 10px;">
                                                {% for stock_code, description, price in available_products %}
                                                    <div class="form-check mb-2">
                                                        <input class="form-check-input" type="checkbox" name="selected_products" 
                                                            value="{{ stock_code }}" id="product_{{ stock_code }}"
                                                            {% if stock_code in valid_stock_codes %}checked{% endif %}>
                                                        <label class="form-check-label" for="product_{{ stock_code }}">
                                                            {{ description }}
                                                            {% if price %}<span class="text-success ms-2">${{ price|floatformat:2 }}</span>{% endif %}
                                                        </label>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                            <div class="form-text">
                                                Click to select/deselect multiple products. Selected products will be used for recommendations.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="fas fa-robot"></i> Get AI Recommendations
                                    </button>
                                    <small class="ms-3 text-muted">
                                        Auto-fallback: Uses manual algorithms if AI is unavailable
                                    </small>
                                </div>
                            </form>
                            
                            <!-- Results Section -->
                            {% if error %}
                                <div class="alert alert-danger">
                                    <i class="fas fa-exclamation-triangle"></i> {{ error }}
                                    {% if available_customers %}
                                        <br><strong>Available customers:</strong> {{ available_customers|join:", " }}
                                    {% endif %}
                                </div>
                            {% endif %}
                            
                            {% if recommendations %}
                                <div class="mt-4">
                                    <h5>
                                        <i class="fas fa-star"></i> Recommendations for Customer {{ target_user_id }}
                                        <span class="badge bg-primary ms-2">{{ recommendations|length }} found</span>
                                    </h5>
                                    
                                    {% if recommendation_source %}
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle"></i> <strong>Source:</strong> {{ recommendation_source }}
                                            {% if error %}
                                                <br><small>{{ error }}</small>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                    
                                    {% if selected_products %}
                                        <div class="mb-3">
                                            <strong>Based on selected products:</strong>
                                            <ul class="list-inline">
                                                {% for product in selected_products %}
                                                    <li class="list-inline-item">
                                                        <span class="badge bg-secondary">{{ product.stock_code }}: {{ product.description }}</span>
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    {% endif %}
                                    
                                    <div class="row">
                                        {% for rec in recommendations %}
                                            <div class="col-md-6 col-lg-4 mb-3">
                                                <div class="card h-100 recommendation-card">
                                                    <div class="card-body">
                                                        <h6 class="card-title">
                                                            <span class="badge bg-primary">{{ rec.stock_code }}</span>
                                                        </h6>
                                                        <p class="card-text">{{ rec.description }}</p>
                                                        <div class="mt-auto">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <span class="text-success fw-bold">
                                                                    ${{ rec.unit_price|floatformat:2 }}
                                                                </span>
                                                                <!-- {% if rec.source %}
                                                                    <small class="text-muted">{{ rec.source }}</small> -->
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables for chat history
// Replace the JavaScript section in your template with this:

// Global variables for chat history
let chatHistory = [];
let currentChatId = null;
let isWaitingForResponse = false;

// Global function for external access
window.fillExampleQuery = fillExampleQuery;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize chat history first
    initializeChatHistory();
    
    // Handle tab persistence
    const urlParams = new URLSearchParams(window.location.search);
    const activeTab = urlParams.get('tab');
    
    // Set active tab based on URL parameter or form submission
    if (activeTab === 'ai-recommendations' || window.location.hash === '#ai-recommendations') {
        // Activate AI Recommendations tab
        const aiTab = document.getElementById('ai-tab');
        const aiContent = document.getElementById('ai-recommendations');
        const chatbotTab = document.getElementById('chatbot-tab');
        const chatbotContent = document.getElementById('chatbot-recommendations');
        
        if (aiTab && aiContent) {
            // Remove active classes from chatbot
            if (chatbotTab) {
                chatbotTab.classList.remove('active');
                chatbotTab.setAttribute('aria-selected', 'false');
            }
            if (chatbotContent) {
                chatbotContent.classList.remove('show', 'active');
                chatbotContent.classList.add('fade');
            }
            
            // Add active classes to AI Recommendations
            aiTab.classList.add('active');
            aiTab.setAttribute('aria-selected', 'true');
            aiContent.classList.add('show', 'active');
            aiContent.classList.remove('fade');
        }
    }
    
    // Handle form submission to add tab parameter
    const form = document.querySelector('form[action*="index"]');
    if (form) {
        form.addEventListener('submit', function(e) {
            // Add tab parameter to form action
            const tabParam = document.createElement('input');
            tabParam.type = 'hidden';
            tabParam.name = 'tab';
            tabParam.value = 'ai-recommendations';
            this.appendChild(tabParam);
        });
    }
    
    // Initialize the chat interface
    initChat();
});

// Initialize chat history and load from session storage fallback
function initializeChatHistory() {
    // Use in-memory storage as fallback since localStorage is not supported
    if (!window.chatHistoryStore) {
        window.chatHistoryStore = [];
    }
    chatHistory = window.chatHistoryStore;
    
    updateChatHistoryDisplay();
    updateChatCount();
    
    // Sidebar toggle functionality
    const sidebarToggle = document.getElementById('sidebar-toggle-btn');
    const sidebar = document.getElementById('chat-history-sidebar');
    const chatMainContent = document.getElementById('chat-main-content');
    
    if (sidebarToggle && sidebar && chatMainContent) {
        sidebarToggle.addEventListener('click', function() {
            sidebar.classList.toggle('collapsed');
            
            if (sidebar.classList.contains('collapsed')) {
                chatMainContent.classList.remove('col-md-9');
                chatMainContent.classList.add('col-md-12');
            } else {
                chatMainContent.classList.remove('col-md-12');
                chatMainContent.classList.add('col-md-9');
            }
        });
    }
    
    // Search functionality
    const searchInput = document.getElementById('chat-search-input');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            filterChatHistory(this.value);
        });
    }
    
    // Start with a new chat if no current chat
    if (!currentChatId) {
        startNewChat();
    }
}

// Fill example query in the input
function fillExampleQuery(query) {
    const chatInput = document.getElementById('chat-input');
    if (chatInput) {
        chatInput.value = query;
        chatInput.focus();
    }
}

// Show the welcome message
function showWelcomeMessage() {
    const welcomeMessage = `
        <div class="message bot-message mb-3">
            <div class="d-flex">
                <div class="avatar me-2"><i class="fas fa-robot"></i></div>
                <div class="message-content">
                    <div class="message-bubble p-3">
                        <strong>AI Assistant:</strong><br>
                        Hello! I'm your AI-powered recommendation assistant. I can help you with:
                        <ul class="mt-2 mb-0">
                            <li><strong>Personalized recommendations</strong> for any customer</li>
                            <li><strong>Customer behavior analysis</strong> and purchase patterns</li>
                            <li><strong>Product insights</strong> and market trends</li>
                            <li><strong>Interactive conversations</strong> about your business data</li>
                        </ul>
                        <div class="mt-3">
                            <strong>Try asking:</strong><br>
                            <span class="example-query" onclick="fillExampleQuery('Recommend products for customer 12345')">"Recommend products for customer 12345"</span><br>
                            <span class="example-query" onclick="fillExampleQuery('What did customer 15311 buy recently?')">"What did customer 15311 buy recently?"</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    const chatMessagesElement = document.getElementById('chat-messages');
    if (chatMessagesElement) {
        chatMessagesElement.innerHTML = welcomeMessage;
    }
}

// Add a message to the DOM
function addMessageToDOM(message, isUser = false, saveToHistory = true) {
    const chatMessagesElement = document.getElementById('chat-messages');
    if (!chatMessagesElement) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'} mb-3`;
    
    messageDiv.innerHTML = `
        <div class="d-flex ${isUser ? 'justify-content-end' : ''}">
            ${!isUser ? '<div class="avatar me-2"><i class="fas fa-robot"></i></div>' : ''}
            <div class="message-content">
                <div class="message-bubble ${isUser ? 'bg-primary text-white' : 'bg-light'} p-3 rounded">
                    ${isUser ? `<strong>You:</strong><br>${message}` : `<strong>AI Assistant:</strong><br>${message}`}
                </div>
            </div>
            ${isUser ? '<div class="avatar ms-2"><i class="fas fa-user"></i></div>' : ''}
        </div>
    `;
    
    chatMessagesElement.appendChild(messageDiv);
    scrollToBottom();
}

// Scroll to the bottom of the chat container
function scrollToBottom() {
    const chatContainer = document.getElementById('chat-container');
    if (chatContainer) {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
}

// Show typing indicator
function showTypingIndicator() {
    const chatMessages = document.getElementById('chat-messages');
    if (!chatMessages) return;
    
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message bot-message mb-3 typing-indicator';
    typingDiv.id = 'typing-indicator';
    
    typingDiv.innerHTML = `
        <div class="d-flex">
            <div class="avatar me-2"><i class="fas fa-robot"></i></div>
            <div class="message-content">
                <div class="message-bubble bg-light p-3 rounded">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <small class="ms-2 text-muted">AI is thinking...</small>
                </div>
            </div>
        </div>
    `;
    
    chatMessages.appendChild(typingDiv);
    scrollToBottom();
}

// Hide typing indicator
function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

// Save messages to chat history
function saveMessagesToHistory(userMessage, botResponse) {
    if (!currentChatId) {
        currentChatId = 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        console.log('Generated new chat ID:', currentChatId);
    }
    
    const timestamp = new Date().toISOString();
    const messages = [
        { type: 'user', content: userMessage, timestamp: timestamp },
        { type: 'bot', content: botResponse, timestamp: timestamp }
    ];
    
    // Find existing chat or create new one
    let existingChatIndex = chatHistory.findIndex(c => c.id === currentChatId);
    
    if (existingChatIndex >= 0) {
        // Update existing chat
        chatHistory[existingChatIndex].messages.push(...messages);
        chatHistory[existingChatIndex].lastUpdated = timestamp;
        
        // Update title if this is still a new chat (has default title or very few messages)
        if (chatHistory[existingChatIndex].title.startsWith('New Chat') || 
            chatHistory[existingChatIndex].messages.length <= 4) {
            chatHistory[existingChatIndex].title = userMessage.substring(0, 30) + (userMessage.length > 30 ? '...' : '');
        }
        
        console.log('Updated existing chat:', currentChatId, 'now has', chatHistory[existingChatIndex].messages.length, 'messages');
    } else {
        // Create new chat entry
        const newChat = {
            id: currentChatId,
            title: userMessage.substring(0, 30) + (userMessage.length > 30 ? '...' : ''),
            messages: messages,
            lastUpdated: timestamp,
            created: timestamp
        };
        chatHistory.unshift(newChat);
        console.log('Created new chat entry:', currentChatId);
    }
    
    // Keep only last 50 chats
    if (chatHistory.length > 50) {
        const removed = chatHistory.splice(50);
        console.log('Removed', removed.length, 'old chats');
    }
    
    // Save to global store
    window.chatHistoryStore = chatHistory;
    
    updateChatHistoryDisplay();
    updateChatCount();
}

// Send a message to the chatbot
function sendMessage() {
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    
    if (!chatInput || !sendButton) {
        console.error('Chat input or send button not found');
        return;
    }
    
    const message = chatInput.value.trim();
    if (!message || isWaitingForResponse) return;
    
    console.log('Sending message to chat:', currentChatId, message);
    
    // Add user message
    addMessageToDOM(message, true, false);
    chatInput.value = '';
    
    // Show typing indicator
    showTypingIndicator();
    isWaitingForResponse = true;
    sendButton.disabled = true;
    chatInput.disabled = true;
    
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        console.error('CSRF token not found');
        hideTypingIndicator();
        addMessageToDOM('<i class="fas fa-times-circle"></i> Error: Security token not found. Please refresh the page.', false, false);
        isWaitingForResponse = false;
        sendButton.disabled = false;
        chatInput.disabled = false;
        return;
    }
    
    // Send to server with chat_id for context isolation
    const chatbotUrl = "{% url 'recommendations:chatbot' %}";
    
    fetch(chatbotUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken.value
        },
        body: JSON.stringify({
            message: message,
            chat_id: currentChatId,  // Include chat_id for context isolation
            user_id: 'web_user_' + Date.now()
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        hideTypingIndicator();
        
        let botResponse = '';
        if (data.status === 'success') {
            botResponse = data.response;
        } else if (data.status === 'fallback') {
            botResponse = `<i class="fas fa-exclamation-triangle"></i> ${data.response}`;
        } else {
            botResponse = `<i class="fas fa-times-circle"></i> ${data.error || 'Sorry, I encountered an error. Please try again.'}`;
        }
        
        addMessageToDOM(botResponse, false, false);
        
        // Save both messages to history at once
        saveMessagesToHistory(message, botResponse);
    })
    .catch(error => {
        hideTypingIndicator();
        console.error('Chat error:', error);
        const errorMessage = '<i class="fas fa-times-circle"></i> Sorry, I encountered a connection error. Please try again.';
        addMessageToDOM(errorMessage, false, false);
        saveMessagesToHistory(message, errorMessage);
    })
    .finally(() => {
        isWaitingForResponse = false;
        sendButton.disabled = false;
        chatInput.disabled = false;
        chatInput.focus();
    });
}

// Initialize the chat interface
function initChat() {
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    
    console.log('Initializing chat...', { chatInput, sendButton });
    
    if (!chatInput || !sendButton) {
        console.error('Chat elements not found');
        return;
    }
    
    // Event listeners
    sendButton.addEventListener('click', function(e) {
        console.log('Send button clicked');
        e.preventDefault();
        sendMessage();
    });
    
    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            console.log('Enter key pressed');
            e.preventDefault();
            sendMessage();
        }
    });
    
    // Focus on chat input when tab is shown
    const chatbotTab = document.getElementById('chatbot-tab');
    if (chatbotTab) {
        chatbotTab.addEventListener('shown.bs.tab', function() {
            chatInput.focus();
        });
    }
    
    // Initial focus
    if (document.getElementById('chatbot-recommendations') && document.getElementById('chatbot-recommendations').classList.contains('active')) {
        chatInput.focus();
    }
    
    console.log('Chat initialized successfully');
}

// Start a new chat
function startNewChat() {
    // Generate new unique chat ID
    currentChatId = 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    console.log('Starting new chat with ID:', currentChatId);
    
    // Clear current chat messages and show welcome
    const chatMessages = document.getElementById('chat-messages');
    if (chatMessages) {
        chatMessages.innerHTML = '';
        showWelcomeMessage();
    }
    
    // Remove active class from all chat items
    document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // Update chat title
    const titleElement = document.getElementById('current-chat-title');
    if (titleElement) {
        titleElement.textContent = 'New Chat - AI Recommendation Chatbot';
    }
    
    // Focus on input
    const chatInput = document.getElementById('chat-input');
    if (chatInput) {
        chatInput.focus();
    }
    
    // Don't save to history yet - wait for first message
    console.log('New chat initialized with fresh context');
}

// Load a specific chat
function loadChat(chatId) {
    const chat = chatHistory.find(c => c.id === chatId);
    if (!chat) {
        console.error('Chat not found:', chatId);
        return;
    }
    
    console.log('Loading chat:', chatId, 'with', chat.messages.length, 'messages');
    
    // Switch to this chat's context
    currentChatId = chatId;
    
    const chatMessages = document.getElementById('chat-messages');
    if (!chatMessages) return;
    
    // Clear current messages
    chatMessages.innerHTML = '';
    
    // Show welcome message first
    showWelcomeMessage();
    
    // Load chat messages (skip welcome messages from history)
    chat.messages.forEach(message => {
        // Skip any messages that look like welcome messages
        if (message.content.includes('Hello! I\'m your AI-powered recommendation assistant')) {
            return;
        }
        addMessageToDOM(message.content, message.type === 'user', false);
    });
    
    // Update UI to show active chat
    document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.remove('active');
    });
    
    const currentChatElement = document.querySelector(`[onclick="loadChat('${chatId}')"]`);
    if (currentChatElement) {
        currentChatElement.classList.add('active');
    }
    
    // Update title
    const titleElement = document.getElementById('current-chat-title');
    if (titleElement) {
        titleElement.textContent = `${chat.title} - AI Recommendation Chatbot`;
    }
    
    // Focus on input
    const chatInput = document.getElementById('chat-input');
    if (chatInput) {
        chatInput.focus();
    }
    
    console.log('Chat loaded successfully. Current chat ID:', currentChatId);
}

// Delete a chat
function deleteChat(chatId) {
    if (confirm('Are you sure you want to delete this chat? This will permanently remove all messages and context.')) {
        console.log('Deleting chat:', chatId);
        
        // Remove from history
        const chatIndex = chatHistory.findIndex(c => c.id === chatId);
        if (chatIndex >= 0) {
            chatHistory.splice(chatIndex, 1);
            window.chatHistoryStore = chatHistory;
            console.log('Chat deleted from history');
        }
        
        // If this was the current chat, start a new one
        if (currentChatId === chatId) {
            console.log('Deleted chat was active, starting new chat');
            startNewChat();
        }
        
        updateChatHistoryDisplay();
        updateChatCount();
    }
}

// Clear all chats
function clearAllChats() {
    if (confirm('Are you sure you want to clear all chat history? This will permanently delete all conversations and their contexts.')) {
        console.log('Clearing all chats');
        
        chatHistory = [];
        window.chatHistoryStore = chatHistory;
        
        // Always start fresh
        startNewChat();
        updateChatHistoryDisplay();
        updateChatCount();
        
        console.log('All chats cleared, new chat started');
    }
}

// Update chat history display
function updateChatHistoryDisplay() {
    const historyList = document.getElementById('chat-history-list');
    if (!historyList) return;
    
    if (chatHistory.length === 0) {
        historyList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-comments"></i>
                <div>No chat history yet</div>
                <small>Start a conversation to see your chat history</small>
            </div>
        `;
        return;
    }
    
    historyList.innerHTML = chatHistory.map(chat => {
        const lastMessage = chat.messages[chat.messages.length - 1];
        const preview = lastMessage ? lastMessage.content.replace(/<[^>]*>/g, '').substring(0, 50) : 'New chat';
        const isActive = chat.id === currentChatId;
        
        return `
            <div class="chat-item ${isActive ? 'active' : ''}" onclick="loadChat('${chat.id}')">
                <div class="chat-name">
                    <span><i class="fas fa-comment"></i> ${chat.title}</span>
                    <button class="chat-delete-btn" onclick="event.stopPropagation(); deleteChat('${chat.id}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="chat-preview">
                    ${preview}${preview.length >= 50 ? '...' : ''}
                </div>
                <div class="chat-date">
                    <i class="fas fa-clock"></i>
                    ${new Date(chat.lastUpdated).toLocaleDateString()}
                </div>
            </div>
        `;
    }).join('');
}

// Update chat count
function updateChatCount() {
    const countBadge = document.getElementById('chat-count-badge');
    const countText = document.getElementById('chat-count');
    const clearBtn = document.getElementById('clear-chats-btn');
    
    if (countBadge) {
        countBadge.textContent = chatHistory.length;
    }
    
    if (countText) {
        countText.textContent = 
            chatHistory.length === 0 ? 'No chats yet' : `${chatHistory.length} chat${chatHistory.length > 1 ? 's' : ''}`;
    }
    
    if (clearBtn) {
        clearBtn.disabled = chatHistory.length === 0;
    }
}

// Filter chat history
function filterChatHistory(searchTerm) {
    const items = document.querySelectorAll('.chat-item');
    const term = searchTerm.toLowerCase();
    
    items.forEach(item => {
        const title = item.querySelector('.chat-name span').textContent.toLowerCase();
        const preview = item.querySelector('.chat-preview').textContent.toLowerCase();
        
        if (title.includes(term) || preview.includes(term)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

// Make functions available globally for onclick handlers
window.startNewChat = startNewChat;
window.loadChat = loadChat;
window.deleteChat = deleteChat;
window.clearAllChats = clearAllChats;
</script>
{% endblock %}