{% extends 'recommendations/base.html' %}

{% block content %}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Arial', -apple-system, BlinkMacSystemFont, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
    }


    /* Purchase History Styles */
    .purchase-summary-container {
        display: flex;
        justify-content: space-between;
        align-items: stretch;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: nowrap; /* ❌ disables wrapping -> all 4 stay in one row */
    }

    /* Make each card equal width */
    .purchase-summary-card {
        flex: 1;
        border-radius: 12px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    /* Hover effect */
    .purchase-summary-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.15);
    }

    .purchase-summary-card .card-body {
        padding: 20px;
    }

    .table th { 
        background: linear-gradient(135deg, #f8f9fa, #e9ecef); border: none; font-weight: 600; color: #2c3e50; 
    } 
    
    .table td { 
        vertical-align: middle; border-color: #f1f3f4; 
    } 
    .badge-invoice {
        background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-size: 0.75rem; padding: 4px 8px; 
    } 
    .price-positive { color: #28a745; font-weight: 600; } 
    .stock-code-badge { background: #f8f9fa; color: #6c757d; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 0.8rem; 
    }

    /* Disabled tab styling */
    .nav-tabs .nav-link:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        color: #6c757d !important;
    }

    .nav-tabs .nav-link:disabled:hover {
        transform: none;
    }

    /* Modern Navbar */
    .navbar {
        background: rgba(255, 255, 255, 0.95) !important;
        backdrop-filter: blur(20px);
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .navbar-brand {
        color: #2c3e50 !important;
        font-weight: 700;
        font-size: 1.5rem;
    }

    /* Main Container */
    .main-container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        margin: 2rem;
        padding: 2rem;
    }

    /* Modern Tabs */
    .nav-tabs {
        border: none;
        background: #f8f9fa;
        border-radius: 15px;
        padding: 0.5rem;
        margin-bottom: 2rem;
    }

    .nav-tabs .nav-link {
        border: none;
        border-radius: 10px;
        padding: 12px 24px;
        font-weight: 600;
        color: #6c757d;
        transition: all 0.3s ease;
        margin: 0 4px;
    }

    .nav-tabs .nav-link.active {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .nav-tabs .nav-link:hover {
        color: #495057;
        transform: translateY(-2px);
    }

    /* Cards */
    .card {
        border: none;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }

    .card-header {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-bottom: 1px solid #dee2e6;
        border-radius: 16px 16px 0 0 !important;
        padding: 1.5rem;
    }

    /* Chat Interface */
    #chat-container {
        background: linear-gradient(135deg, #fafbfc, #f1f3f4);
        border-radius: 12px;
        height: 500px;
        overflow-y: auto;
        padding: 20px;
        border: 1px solid #e9ecef;
    }

    .message-bubble {
        max-width: 80%;
        word-wrap: break-word;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border-radius: 18px;
    }

    .bot-message .message-bubble {
        background: linear-gradient(135deg, #e3f2fd, #f3e5f5) !important;
        border: 1px solid #e1f5fe;
    }

    .user-message .message-bubble {
        background: linear-gradient(135deg, #667eea, #764ba2) !important;
        color: white;
    }

    .avatar {
        font-size: 24px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    /* Buttons */
    .btn {
        border-radius: 10px;
        padding: 12px 24px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea, #764ba2);
        border: none;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
    }

    .btn-warning {
        background: linear-gradient(135deg, #ffd93d, #ff6b6b);
        border: none;
        color: white;
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
    }

    /* Form Controls */
    .form-control, .form-select {
        border-radius: 10px;
        border: 2px solid #e9ecef;
        padding: 12px 16px;
        transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    /* Recommendation Cards */
    .recommendation-card {
        border: 1px solid #e9ecef;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        background: linear-gradient(135deg, #f8f9fa, #ffffff);
        transition: all 0.3s ease;
    }

    .recommendation-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    /* Alerts */
    .alert {
        border: none;
        border-radius: 12px;
        padding: 20px;
    }

    .alert-info {
        background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
        color: #1565c0;
    }

    /* Loading Animation */
    .typing-indicator {
        display: none;
    }

    .typing-indicator.show {
        display: block;
    }

    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
    }

    /* Typing dots animation */
    .typing-dots {
        display: inline-flex;
        align-items: center;
    }

    .typing-dots span {
        height: 8px;
        width: 8px;
        background-color: #6c757d;
        border-radius: 50%;
        display: inline-block;
        margin: 0 2px;
        animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dots span:nth-child(1) {
        animation-delay: -0.32s;
    }

    .typing-dots span:nth-child(2) {
        animation-delay: -0.16s;
    }

    @keyframes typing {
        0%, 80%, 100% {
            transform: scale(0.8);
            opacity: 0.5;
        }
        40% {
            transform: scale(1);
            opacity: 1;
        }
    }

    /* Interactive Elements */
    .example-query {
        cursor: pointer;
        color: #667eea !important;
        transition: all 0.3s ease;
        padding: 2px 6px;
        border-radius: 6px;
    }

    .example-query:hover {
        background: rgba(102, 126, 234, 0.1);
        text-decoration: none !important;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .main-container {
            margin: 1rem;
            padding: 1rem;
        }
        
        #chat-container {
            height: 400px;
        }
    }

    /* Animations */
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .tab-content {
        animation: slideIn 0.5s ease;
    }

    /*  Chat History Sidebar */

/* Chat History Sidebar */
.chat-history-sidebar {
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(20px);
    border-radius: 16px;
    padding: 0;
    height: 600px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transition: width 0.3s ease;
    position: relative;
}

.chat-history-sidebar.collapsed {
    width: 50px;
    min-width: 50px;
}

.sidebar-toggle-btn {
    position: absolute;
    top: 10px;
    right: -15px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.sidebar-toggle-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
}

.chat-history-sidebar.collapsed .sidebar-toggle-btn i {
    transform: rotate(180deg);
}

.sidebar-content {
    padding: 1rem;
    transition: opacity 0.3s ease;
    flex: 1;
    display: flex;
    flex-direction: column;
}

.chat-history-sidebar.collapsed .sidebar-content {
    opacity: 0;
    pointer-events: none;
}

.chat-history-header {
    border-bottom: 1px solid #e9ecef;
    padding-bottom: 1rem;
    margin-bottom: 1rem;
}

.chat-history-header h5 {
    color: #2c3e50;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.chat-count-badge {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.7rem;
    font-weight: 600;
}

.chat-search {
    margin-bottom: 1rem;
}

.new-chat-btn {
    width: 100%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 12px 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.new-chat-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.chat-management-options {
    padding: 0.5rem 0;
    border-top: 1px solid #f1f3f4;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chat-item {
    background: rgba(248, 249, 250, 0.8);
    border: 1px solid #e9ecef;
    border-radius: 12px;
    margin-bottom: 0.75rem;
    padding: 0.75rem;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.chat-item:hover {
    background: rgba(102, 126, 234, 0.1);
    border-color: #667eea;
    transform: translateX(2px);
}

.chat-item.active {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15));
    border-color: #667eea;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
}

.chat-item.active::before {
    content: '';
    position: absolute;
    left: -4px;
    top: 50%;
    transform: translateY(-50%);
    width: 4px;
    height: 70%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 0 4px 4px 0;
}

.chat-name {
    font-weight: 600;
    color: #2c3e50;
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chat-preview {
    font-size: 0.8rem;
    color: #6c757d;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    line-height: 1.4;
}

.chat-date {
    font-size: 0.7rem;
    color: #adb5bd;
    margin-top: 0.25rem;
    display: flex;
    align-items: center;
}

.chat-date i {
    margin-right: 4px;
    font-size: 0.6rem;
}

#chat-history-list {
    flex: 1;
    overflow-y: auto;
    padding-right: 5px;
}

#chat-history-list::-webkit-scrollbar {
    width: 6px;
}

#chat-history-list::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

#chat-history-list::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

#chat-history-list::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

.empty-state {
    text-align: center;
    padding: 2rem 1rem;
    color: #6c757d;
}

.empty-state i {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.chat-delete-btn {
    opacity: 0;
    transition: opacity 0.3s ease;
    background: none;
    border: none;
    color: #dc3545;
    cursor: pointer;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.7rem;
}

.chat-item:hover .chat-delete-btn {
    opacity: 1;
}

.chat-delete-btn:hover {
    background: rgba(220, 53, 69, 0.1);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .chat-history-sidebar {
        position: fixed;
        left: -300px;
        top: 0;
        height: 100vh;
        width: 300px;
        z-index: 1000;
        transition: left 0.3s ease;
    }
    
    .chat-history-sidebar.mobile-open {
        left: 0;
    }
    
    .chat-history-sidebar.collapsed {
        left: -300px;
    }
}

    /* User info bar */
   .user-info-bar {
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        border-radius: 15px;
        padding: 1rem 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .user-actions {
        display: flex;
        gap: 0.75rem;
        align-items: center;
    }

    .dashboard-btn {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        text-decoration: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .dashboard-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        color: white;
        text-decoration: none;
    }

    .logout-btn {
        background: linear-gradient(135deg, #dc3545, #c82333);
        color: white;
        text-decoration: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .logout-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
        color: white;
        text-decoration: none;
    }

    .login-prompt {
        background: linear-gradient(135deg, #ffc107, #fd7e14);
        color: #212529;
        text-decoration: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .login-prompt:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 193, 7, 0.4);
        color: #212529;
        text-decoration: none;
    }


     /* Product selection checkboxes */
.product-checkbox-container {
    background: #fafbfc;
}

.product-checkbox-container .form-check {
    padding: 8px 12px;
    border-radius: 6px;
    transition: background-color 0.2s ease;
}

.product-checkbox-container .form-check:hover {
    background-color: rgba(102, 126, 234, 0.1);
}

.product-checkbox-container .form-check-input:checked + .form-check-label {
    color: #667eea;
    font-weight: 600;
}

.form-check-label {
    cursor: pointer;
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
</style>
<div class="main-container">

    <!-- User Info Bar -->
     <div class="user-info-bar">
        <div class="d-flex justify-content-between align-items-center">
            {% if customer_id %}
                <div>
                    <span class="text-muted">Welcome back,</span>
                    <strong class="text-primary">Customer ID: {{ customer_id }}</strong>
                </div>
                <div class="user-actions">
                    <a href="{% url 'recommendations:customer_dashboard' %}" class="dashboard-btn">
                        <i class="fas fa-chart-line"></i> View My Dashboard
                    </a>
                    <a href="{% url 'recommendations:logout' %}" class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </div>
            {% else %}
                <div>
                    <span class="text-muted">Get personalized recommendations and insights</span>
                </div>
                <div class="user-actions">
                    <a href="{% url 'recommendations:login' %}" class="login-prompt">
                        <i class="fas fa-sign-in-alt"></i> Login for Personalized Experience
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
    <!-- End User Info Bar -->

    <!-- Tab Navigation -->
    <ul class="nav nav-tabs" id="recommendationTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link{% if active_tab == 'chatbot' or not active_tab %} active{% endif %}" 
                    id="chatbot-tab" data-bs-toggle="tab" data-bs-target="#chatbot-recommendations" 
                    type="button" role="tab" aria-controls="chatbot-recommendations" 
                    aria-selected="{% if active_tab == 'chatbot' or not active_tab %}true{% else %}false{% endif %}">
                AI Chatbot
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link{% if active_tab == 'ai-recommendations' %} active{% endif %}" 
                    id="ai-tab" data-bs-toggle="tab" data-bs-target="#ai-recommendations" 
                    type="button" role="tab" aria-controls="ai-recommendations" 
                    aria-selected="{% if active_tab == 'ai-recommendations' %}true{% else %}false{% endif %}">
                AI Recommendations
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link{% if active_tab == 'purchase-history' %} active{% endif %}" 
                    id="purchase-history-tab" data-bs-toggle="tab" data-bs-target="#purchase-history" 
                    type="button" role="tab" aria-controls="purchase-history" 
                    aria-selected="{% if active_tab == 'purchase-history' %}true{% else %}false{% endif %}"
                    {% if not customer_id %}disabled title="Login required to view purchase history"{% endif %}>
                <i class="fas fa-history"></i> Purchase History
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="recommendationTabContent">
        
        <!-- AI Chatbot Tab -->
        <div class="tab-pane fade{% if active_tab == 'chatbot' or not active_tab %} show active{% endif %}" 
             id="chatbot-recommendations" role="tabpanel" aria-labelledby="chatbot-tab">
            <div class="row">
                <!-- Chat History Sidebar -->
                <div class="col-md-3">
                    <div class="chat-history-sidebar" id="chat-history-sidebar">
                        <button class="sidebar-toggle-btn" id="sidebar-toggle-btn">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        
                        <div class="sidebar-content">
                            <div class="chat-history-header">
                                <h5>
                                    <i class="fas fa-history"></i>
                                    Chat History 
                                    <span class="chat-count-badge" id="chat-count-badge">0</span>
                                </h5>
                                <div class="chat-search">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        <input type="text" class="form-control" placeholder="Search chats..." id="chat-search-input">
                                    </div>
                                </div>
                                <button class="new-chat-btn" onclick="startNewChat()">
                                    <i class="fas fa-plus"></i> New Chat
                                </button>
                                <div class="chat-management-options">
                                    <small class="text-muted" id="chat-count">No chats yet</small>
                                    <div class="chat-actions">
                                        <button class="btn btn-sm btn-outline-danger" onclick="clearAllChats()" 
                                                title="Clear all chats" id="clear-chats-btn" disabled>
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="chat-history-list">
                                <div class="empty-state">
                                    <i class="fas fa-comments"></i>
                                    <div>No chat history yet</div>
                                    <small>Start a conversation to see your chat history</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Chat Interface -->
                <div class="col-md-9" id="chat-main-content">
                    <div class="card">
                        <div class="card-header">
                            <h5 id="current-chat-title">AI Recommendation Chatbot</h5>
                            <small class="text-muted">Ask me anything about customer recommendations, purchase history, or product insights!</small>
                        </div>
                        <div class="card-body p-0">
                            <!-- Chat Interface -->
                            <div id="chat-container">
                                <div id="chat-messages">
                                    <!-- Welcome message -->
                                    <div class="message bot-message mb-3">
                                        <div class="d-flex">
                                            <div class="avatar me-2"><i class="fas fa-robot"></i></div>
                                            <div class="message-content">
                                                <div class="message-bubble p-3">
                                                    <strong>AI Assistant:</strong><br>
                                                    Hello! I'm your AI-powered recommendation assistant. I can help you with:
                                                    <ul class="mt-2 mb-0">
                                                        <li><strong>Personalized recommendations</strong> for any customer</li>
                                                        <li><strong>Customer behavior analysis</strong> and purchase patterns</li>
                                                        <li><strong>Product insights</strong> and market trends</li>
                                                        <li><strong>Interactive conversations</strong> about your business data</li>
                                                    </ul>
                                                    <div class="mt-3">
                                                        <strong>Try asking:</strong><br>
                                                        <span class="example-query" onclick="fillExampleQuery('Recommend products for customer 12345')">"Recommend products for customer 12345"</span><br>
                                                        <span class="example-query" onclick="fillExampleQuery('What did customer 15311 buy recently?')">"What did customer 15311 buy recently?"</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Chat Input -->
                            <div class="chat-input-container p-3">
                                <div class="input-group">
                                    <input type="text" id="chat-input" class="form-control" 
                                           placeholder="Ask me about recommendations, customers, or products..." 
                                           autocomplete="off">
                                    <button id="send-button" class="btn btn-primary">
                                        <i class="fas fa-paper-plane"></i> Send
                                    </button>
                                </div>
                                <small class="text-muted mt-1 d-block">
                                    Tip: Be specific with customer IDs or product details for better recommendations
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Recommendations Tab -->
        <div class="tab-pane fade{% if active_tab == 'ai-recommendations' %} show active{% endif %}" 
             id="ai-recommendations" role="tabpanel" aria-labelledby="ai-tab">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>AI Recommendations</h5>
                            <small class="text-muted">Advanced AI recommendations with automatic fallback to manual algorithms</small>
                        </div>
                        <div class="card-body">
                            <form method="post" action="{% url 'recommendations:index' %}">
                                {% csrf_token %}
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="target_user_id" class="form-label">
                                                <strong>Customer ID</strong>
                                            </label>
                                            {% if customer_id %}
                                                <input type="number" class="form-control" name="target_user_id" 
                                                    value="{{ customer_id }}" readonly 
                                                    style="background-color: #f8f9fa; cursor: not-allowed;">
                                                <div class="form-text">
                                                    Using your logged-in customer ID. <a href="{% url 'recommendations:logout' %}">Switch account?</a>
                                                </div>
                                            {% else %}
                                                <input type="number" class="form-control" name="target_user_id" 
                                                    value="{{ target_user_id|default:'' }}" 
                                                    placeholder="Enter customer ID (e.g., 12345)" required>
                                                <div class="form-text">
                                                    <a href="{% url 'recommendations:login' %}">Login</a> to auto-fill your customer ID.
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="selected_products" class="form-label">
                                                <strong>Select Products</strong> 
                                                <span class="text-danger">*</span>
                                            </label>
                                            <div class="product-checkbox-container" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; padding: 10px;">
                                                {% for stock_code, description, price in available_products %}
                                                    <div class="form-check mb-2">
                                                        <input class="form-check-input" type="checkbox" name="selected_products" 
                                                            value="{{ stock_code }}" id="product_{{ stock_code }}"
                                                            {% if stock_code in valid_stock_codes %}checked{% endif %}>
                                                        <label class="form-check-label" for="product_{{ stock_code }}">
                                                            {{ description }}
                                                            {% if price %}<span class="text-success ms-2">${{ price|floatformat:2 }}</span>{% endif %}
                                                        </label>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                            <div class="form-text">
                                                Click to select/deselect multiple products. Selected products will be used for recommendations.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="fas fa-robot"></i> Get AI Recommendations
                                    </button>
                                    <small class="ms-3 text-muted">
                                        Auto-fallback: Uses manual algorithms if AI is unavailable
                                    </small>
                                </div>
                            </form>
                            
                            <!-- Results Section -->
                            {% if error %}
                                <div class="alert alert-danger">
                                    <i class="fas fa-exclamation-triangle"></i> {{ error }}
                                    {% if available_customers %}
                                        <br><strong>Available customers:</strong> {{ available_customers|join:", " }}
                                    {% endif %}
                                </div>
                            {% endif %}
                            
                            {% if recommendations %}
                                <div class="mt-4">
                                    <h5>
                                        <i class="fas fa-star"></i> Recommendations for Customer {{ target_user_id }}
                                        <span class="badge bg-primary ms-2">{{ recommendations|length }} found</span>
                                    </h5>
                                    
                                    {% if recommendation_source %}
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle"></i> <strong>Source:</strong> {{ recommendation_source }}
                                            {% if error %}
                                                <br><small>{{ error }}</small>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                    
                                    {% if selected_products %}
                                        <div class="mb-3">
                                            <strong>Based on selected products:</strong>
                                            <ul class="list-inline">
                                                {% for product in selected_products %}
                                                    <li class="list-inline-item">
                                                        <span class="badge bg-secondary">{{ product.stock_code }}: {{ product.description }}</span>
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    {% endif %}
                                    
                                    <div class="row">
                                        {% for rec in recommendations %}
                                            <div class="col-md-6 col-lg-4 mb-3">
                                                <div class="card h-100 recommendation-card">
                                                    <div class="card-body">
                                                        <h6 class="card-title">
                                                            <span class="badge bg-primary">{{ rec.stock_code }}</span>
                                                        </h6>
                                                        <p class="card-text">{{ rec.description }}</p>
                                                        <div class="mt-auto">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <span class="text-success fw-bold">
                                                                    ${{ rec.unit_price|floatformat:2 }}
                                                                </span>
                                                                {% if rec.source %}
                                                                    <small class="text-muted">{{ rec.source }}</small>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Purchase History Tab -->
        <div class="tab-pane fade{% if active_tab == 'purchase-history' %} show active{% endif %}" 
             id="purchase-history" role="tabpanel" aria-labelledby="purchase-history-tab">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-shopping-cart"></i> My Purchase History</h5>
                            <small class="text-muted">View all your past purchases with detailed information</small>
                        </div>
                        <div class="card-body">
                            {% if not customer_id %}
                                <div class="alert alert-warning text-center">
                                    <i class="fas fa-sign-in-alt fa-2x mb-3"></i>
                                    <h5>Login Required</h5>
                                    <p>Please login to view your purchase history.</p>
                                    <a href="{% url 'recommendations:login' %}" class="btn btn-primary">
                                        <i class="fas fa-sign-in-alt"></i> Login Now
                                    </a>
                                </div>
                            {% else %}
                                <!-- Loading State -->
                                <div id="purchase-loading" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 text-muted">Loading your purchase history...</p>
                                </div>

                                <!-- Purchase Summary -->
                                <div id="purchase-summary" class="purchase-summary-container">
                                    <div class="purchase-summary-card bg-primary text-white">
                                        <div class="card-body text-center">
                                            <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                                            <h4 id="total-purchases">0</h4>
                                            <small>Total Purchases</small>
                                        </div>
                                    </div>
                                    <div class="purchase-summary-card bg-success text-white">
                                        <div class="card-body text-center">
                                            <i class="fas fa-dollar-sign fa-2x mb-2"></i>
                                            <h4 id="total-spent">$0</h4>
                                            <small>Total Spent</small>
                                        </div>
                                    </div>
                                    <div class="purchase-summary-card bg-info text-white">
                                        <div class="card-body text-center">
                                            <i class="fas fa-box fa-2x mb-2"></i>
                                            <h4 id="unique-products">0</h4>
                                            <small>Unique Products</small>
                                        </div>
                                    </div>
                                    <div class="purchase-summary-card bg-warning text-white">
                                        <div class="card-body text-center">
                                            <i class="fas fa-receipt fa-2x mb-2"></i>
                                            <h4 id="avg-order-value">$0</h4>
                                            <small>Avg Order Value</small>
                                        </div>
                                    </div>
                                </div>


                                <!-- Search and Filter -->
                                <div id="purchase-controls" class="row mb-3" style="display: none;">
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                                            <input type="text" class="form-control" id="purchase-search" 
                                                   placeholder="Search by product name or stock code...">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="purchase-sort">
                                            <option value="date-desc">Newest First</option>
                                            <option value="date-asc">Oldest First</option>
                                            <option value="price-desc">Highest Price</option>
                                            <option value="price-asc">Lowest Price</option>
                                            <option value="qty-desc">Highest Quantity</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-outline-secondary" onclick="exportPurchaseHistory()">
                                            <i class="fas fa-download"></i> Export
                                        </button>
                                    </div>
                                </div>

                                <!-- Purchase History Table -->
                                <div id="purchase-table-container" style="display: none;">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Invoice</th>
                                                    <th>Product</th>
                                                    <th>Stock Code</th>
                                                    <th>Quantity</th>
                                                    <th>Unit Price</th>
                                                    <th>Total</th>
                                                    <th>Purchase Date</th>
                                                </tr>
                                            </thead>
                                            <tbody id="purchase-table-body">
                                                <!-- Purchases will be loaded here -->
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <!-- Pagination -->
                                    <nav aria-label="Purchase history pagination">
                                        <ul class="pagination justify-content-center" id="purchase-pagination">
                                            <!-- Pagination buttons will be added here -->
                                        </ul>
                                    </nav>
                                </div>

                                <!-- Empty State -->
                                <div id="purchase-empty" class="text-center py-5" style="display: none;">
                                    <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">No Purchase History Found</h5>
                                    <p class="text-muted">You haven't made any purchases yet.</p>
                                </div>

                                <!-- Error State -->
                                <div id="purchase-error" class="alert alert-danger" style="display: none;">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <strong>Error Loading Purchase History</strong>
                                    <p id="purchase-error-message" class="mb-0">Unable to load your purchase history. Please try again.</p>
                                    <button class="btn btn-outline-danger mt-2" onclick="loadPurchaseHistory()">
                                        <i class="fas fa-retry"></i> Retry
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
// Global variables for chat history
let chatHistory = [];
let currentChatId = null;
let isWaitingForResponse = false;

// Purchase History Variables
let allPurchases = [];
let filteredPurchases = [];
let currentPage = 1;
const itemsPerPage = 20;

// Global function for external access
window.fillExampleQuery = fillExampleQuery;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize chat history first
    initializeChatHistory();
    
    // Handle tab persistence
    const urlParams = new URLSearchParams(window.location.search);
    const activeTab = urlParams.get('tab');
    
    // Set active tab based on URL parameter or form submission
    if (activeTab === 'ai-recommendations' || window.location.hash === '#ai-recommendations') {
        // Activate AI Recommendations tab
        const aiTab = document.getElementById('ai-tab');
        const aiContent = document.getElementById('ai-recommendations');
        const chatbotTab = document.getElementById('chatbot-tab');
        const chatbotContent = document.getElementById('chatbot-recommendations');
        
        if (aiTab && aiContent) {
            // Remove active classes from chatbot
            if (chatbotTab) {
                chatbotTab.classList.remove('active');
                chatbotTab.setAttribute('aria-selected', 'false');
            }
            if (chatbotContent) {
                chatbotContent.classList.remove('show', 'active');
                chatbotContent.classList.add('fade');
            }
            
            // Add active classes to AI Recommendations
            aiTab.classList.add('active');
            aiTab.setAttribute('aria-selected', 'true');
            aiContent.classList.add('show', 'active');
            aiContent.classList.remove('fade');
        }
    }
    
    // Handle form submission to add tab parameter
    const form = document.querySelector('form[action*="index"]');
    if (form) {
        form.addEventListener('submit', function(e) {
            // Add tab parameter to form action
            const tabParam = document.createElement('input');
            tabParam.type = 'hidden';
            tabParam.name = 'tab';
            tabParam.value = 'ai-recommendations';
            this.appendChild(tabParam);
        });
    }
    
    // Initialize the chat interface
    initChat();
    
    // Add purchase history tab event listener
    const purchaseHistoryTab = document.getElementById('purchase-history-tab');
    if (purchaseHistoryTab && !purchaseHistoryTab.disabled) {
        purchaseHistoryTab.addEventListener('shown.bs.tab', function() {
            loadPurchaseHistory();
        });
        
        // Load immediately if this tab is active
        if (purchaseHistoryTab.classList.contains('active')) {
            loadPurchaseHistory();
        }
    }
    
    // Add search functionality for purchase history
    const searchInput = document.getElementById('purchase-search');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            filterPurchases(this.value);
        });
    }
    
    // Add sort functionality for purchase history
    const sortSelect = document.getElementById('purchase-sort');
    if (sortSelect) {
        sortSelect.addEventListener('change', function() {
            sortPurchases(this.value);
        });
    }
});


// Helper function to activate tabs
function activateTab(tabId, contentId) {
    // Deactivate all tabs
    document.querySelectorAll('.nav-tabs .nav-link').forEach(tab => {
        tab.classList.remove('active');
        tab.setAttribute('aria-selected', 'false');
    });
    
    // Deactivate all tab contents
    document.querySelectorAll('.tab-content .tab-pane').forEach(pane => {
        pane.classList.remove('show', 'active');
    });
    
    // Activate target tab
    const targetTab = document.getElementById(tabId);
    const targetContent = document.getElementById(contentId);
    
    if (targetTab && targetContent) {
        targetTab.classList.add('active');
        targetTab.setAttribute('aria-selected', 'true');
        targetContent.classList.add('show', 'active');
    }
}

// =================== CHAT HISTORY FUNCTIONS ===================

// Initialize chat history and load from session storage fallback
function initializeChatHistory() {
    // Load chat history from database
    loadChatHistoryFromDB();
    
    // Sidebar toggle functionality
    const sidebarToggle = document.getElementById('sidebar-toggle-btn');
    const sidebar = document.getElementById('chat-history-sidebar');
    const chatMainContent = document.getElementById('chat-main-content');
    
    if (sidebarToggle && sidebar && chatMainContent) {
        sidebarToggle.addEventListener('click', function() {
            sidebar.classList.toggle('collapsed');
            
            if (sidebar.classList.contains('collapsed')) {
                chatMainContent.classList.remove('col-md-9');
                chatMainContent.classList.add('col-md-12');
            } else {
                chatMainContent.classList.remove('col-md-12');
                chatMainContent.classList.add('col-md-9');
            }
        });
    }
    
    // Search functionality for chat history
    const chatSearchInput = document.getElementById('chat-search-input');
    if (chatSearchInput) {
        chatSearchInput.addEventListener('input', function() {
            filterChatHistory(this.value);
        });
    }
    
    // Start with a new chat if no current chat
    if (!currentChatId) {
        startNewChat();
    }
}

function loadChatHistoryFromDB() {
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        console.error('CSRF token not found');
        return;
    }

    fetch("{% url 'recommendations:get_chat_history' %}", {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrfToken.value,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            chatHistory = data.chats || [];
            console.log('Loaded', chatHistory.length, 'chats from database');
            updateChatHistoryDisplay();
            updateChatCount();
        } else {
            console.error('Error loading chat history:', data.error);
        }
    })
    .catch(error => {
        console.error('Failed to load chat history:', error);
    });
}

function saveChatToDB(chatId, title, messages) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        console.error('CSRF token not found');
        return;
    }

    fetch("{% url 'recommendations:save_chat_messages' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken.value
        },
        body: JSON.stringify({
            chat_id: chatId,
            title: title,
            messages: messages
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            console.log('Chat saved to database:', chatId);
        } else {
            console.error('Failed to save chat:', data.error);
        }
    })
    .catch(error => {
        console.error('Error saving chat:', error);
    });
}

// Delete a chat
function deleteChat(chatId) {
    if (confirm('Are you sure you want to delete this chat? This will permanently remove all messages and context.')) {
        console.log('Deleting chat:', chatId);
        
        // Delete from database
        fetch("{% url 'recommendations:delete_chat' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                chat_id: chatId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Remove from memory
                const chatIndex = chatHistory.findIndex(c => c.id === chatId);
                if (chatIndex >= 0) {
                    chatHistory.splice(chatIndex, 1);
                }
                
                // If this was the current chat, start a new one
                if (currentChatId === chatId) {
                    startNewChat();
                }
                
                updateChatHistoryDisplay();
                updateChatCount();
                console.log('Chat deleted successfully');
            } else {
                console.error('Failed to delete chat:', data.error);
                alert('Failed to delete chat. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error deleting chat:', error);
            alert('Error deleting chat. Please try again.');
        });
    }
}

// Fill example query in the input
function fillExampleQuery(query) {
    const chatInput = document.getElementById('chat-input');
    if (chatInput) {
        chatInput.value = query;
        chatInput.focus();
    }
}

// Show the welcome message
function showWelcomeMessage() {
    const welcomeMessage = `
        <div class="message bot-message mb-3">
            <div class="d-flex">
                <div class="avatar me-2"><i class="fas fa-robot"></i></div>
                <div class="message-content">
                    <div class="message-bubble p-3">
                        <strong>AI Assistant:</strong><br>
                        Hello! I'm your AI-powered recommendation assistant. I can help you with:
                        <ul class="mt-2 mb-0">
                            <li><strong>Personalized recommendations</strong> for any customer</li>
                            <li><strong>Customer behavior analysis</strong> and purchase patterns</li>
                            <li><strong>Product insights</strong> and market trends</li>
                            <li><strong>Interactive conversations</strong> about your business data</li>
                        </ul>
                        <div class="mt-3">
                            <strong>Try asking:</strong><br>
                            <span class="example-query" onclick="fillExampleQuery('Recommend products for customer 12345')">"Recommend products for customer 12345"</span><br>
                            <span class="example-query" onclick="fillExampleQuery('What did customer 15311 buy recently?')">"What did customer 15311 buy recently?"</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    const chatMessagesElement = document.getElementById('chat-messages');
    if (chatMessagesElement) {
        chatMessagesElement.innerHTML = welcomeMessage;
    }
}

// Add a message to the DOM
function addMessageToDOM(message, isUser = false, saveToHistory = true) {
    const chatMessagesElement = document.getElementById('chat-messages');
    if (!chatMessagesElement) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'} mb-3`;
    
    messageDiv.innerHTML = `
        <div class="d-flex ${isUser ? 'justify-content-end' : ''}">
            ${!isUser ? '<div class="avatar me-2"><i class="fas fa-robot"></i></div>' : ''}
            <div class="message-content">
                <div class="message-bubble ${isUser ? 'bg-primary text-white' : 'bg-light'} p-3 rounded">
                    ${isUser ? `<strong>You:</strong><br>${message}` : `<strong>AI Assistant:</strong><br>${message}`}
                </div>
            </div>
            ${isUser ? '<div class="avatar ms-2"><i class="fas fa-user"></i></div>' : ''}
        </div>
    `;
    
    chatMessagesElement.appendChild(messageDiv);
    scrollToBottom();
}

// Scroll to the bottom of the chat container
function scrollToBottom() {
    const chatContainer = document.getElementById('chat-container');
    if (chatContainer) {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
}

// Show typing indicator
function showTypingIndicator() {
    const chatMessages = document.getElementById('chat-messages');
    if (!chatMessages) return;
    
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message bot-message mb-3 typing-indicator';
    typingDiv.id = 'typing-indicator';
    
    typingDiv.innerHTML = `
        <div class="d-flex">
            <div class="avatar me-2"><i class="fas fa-robot"></i></div>
            <div class="message-content">
                <div class="message-bubble bg-light p-3 rounded">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <small class="ms-2 text-muted">AI is thinking...</small>
                </div>
            </div>
        </div>
    `;
    
    chatMessages.appendChild(typingDiv);
    scrollToBottom();
}

// Hide typing indicator
function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

// Save messages to chat history
function saveMessagesToHistory(userMessage, botResponse) {
    if (!currentChatId) {
        currentChatId = 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        console.log('Generated new chat ID:', currentChatId);
    }
    
    const timestamp = new Date().toISOString();
    const messages = [
        { type: 'user', content: userMessage, timestamp: timestamp },
        { type: 'bot', content: botResponse, timestamp: timestamp }
    ];
    
    // Find existing chat or create new one in memory
    let existingChatIndex = chatHistory.findIndex(c => c.id === currentChatId);
    let chatTitle = userMessage.substring(0, 30) + (userMessage.length > 30 ? '...' : '');
    let allMessages = [];
    
    if (existingChatIndex >= 0) {
        // Update existing chat
        chatHistory[existingChatIndex].messages.push(...messages);
        chatHistory[existingChatIndex].lastUpdated = timestamp;
        
        // Update title if this is still a new chat
        if (chatHistory[existingChatIndex].title.startsWith('New Chat') || 
            chatHistory[existingChatIndex].messages.length <= 4) {
            chatHistory[existingChatIndex].title = chatTitle;
        }
        
        allMessages = chatHistory[existingChatIndex].messages;
        chatTitle = chatHistory[existingChatIndex].title;
    } else {
        // Create new chat entry
        const newChat = {
            id: currentChatId,
            title: chatTitle,
            messages: messages,
            lastUpdated: timestamp,
            created: timestamp
        };
        chatHistory.unshift(newChat);
        allMessages = messages;
    }
    
    // Save to database
    saveChatToDB(currentChatId, chatTitle, allMessages);
    
    updateChatHistoryDisplay();
    updateChatCount();
}

// Send a message to the chatbot
function sendMessage() {
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    
    if (!chatInput || !sendButton) {
        console.error('Chat input or send button not found');
        return;
    }
    
    const message = chatInput.value.trim();
    if (!message || isWaitingForResponse) return;
    
    console.log('Sending message to chat:', currentChatId, message);
    
    // Add user message
    addMessageToDOM(message, true, false);
    chatInput.value = '';
    
    // Show typing indicator
    showTypingIndicator();
    isWaitingForResponse = true;
    sendButton.disabled = true;
    chatInput.disabled = true;
    
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        console.error('CSRF token not found');
        hideTypingIndicator();
        addMessageToDOM('<i class="fas fa-times-circle"></i> Error: Security token not found. Please refresh the page.', false, false);
        isWaitingForResponse = false;
        sendButton.disabled = false;
        chatInput.disabled = false;
        return;
    }
    
    // Send to server with chat_id for context isolation
    const chatbotUrl = "{% url 'recommendations:chatbot' %}";
    
    fetch(chatbotUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken.value
        },
        body: JSON.stringify({
            message: message,
            chat_id: currentChatId,  // Include chat_id for context isolation
            user_id: 'web_user_' + Date.now()
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        hideTypingIndicator();
        
        let botResponse = '';
        if (data.status === 'success') {
            botResponse = data.response;
        } else if (data.status === 'fallback') {
            botResponse = `<i class="fas fa-exclamation-triangle"></i> ${data.response}`;
        } else {
            botResponse = `<i class="fas fa-times-circle"></i> ${data.error || 'Sorry, I encountered an error. Please try again.'}`;
        }
        
        addMessageToDOM(botResponse, false, false);
        
        // Save both messages to history at once
        saveMessagesToHistory(message, botResponse);
    })
    .catch(error => {
        hideTypingIndicator();
        console.error('Chat error:', error);
        const errorMessage = '<i class="fas fa-times-circle"></i> Sorry, I encountered a connection error. Please try again.';
        addMessageToDOM(errorMessage, false, false);
        saveMessagesToHistory(message, errorMessage);
    })
    .finally(() => {
        isWaitingForResponse = false;
        sendButton.disabled = false;
        chatInput.disabled = false;
        chatInput.focus();
    });
}

// Initialize the chat interface
function initChat() {
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    
    console.log('Initializing chat...', { chatInput, sendButton });
    
    if (!chatInput || !sendButton) {
        console.error('Chat elements not found');
        return;
    }
    
    // Event listeners
    sendButton.addEventListener('click', function(e) {
        console.log('Send button clicked');
        e.preventDefault();
        sendMessage();
    });
    
    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            console.log('Enter key pressed');
            e.preventDefault();
            sendMessage();
        }
    });
    
    // Focus on chat input when tab is shown
    const chatbotTab = document.getElementById('chatbot-tab');
    if (chatbotTab) {
        chatbotTab.addEventListener('shown.bs.tab', function() {
            chatInput.focus();
        });
    }
    
    // Initial focus
    if (document.getElementById('chatbot-recommendations') && document.getElementById('chatbot-recommendations').classList.contains('active')) {
        chatInput.focus();
    }
    
    console.log('Chat initialized successfully');
}

// Start a new chat
function startNewChat() {
    // Generate new unique chat ID
    currentChatId = 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    console.log('Starting new chat with ID:', currentChatId);
    
    // Clear current chat messages and show welcome
    const chatMessages = document.getElementById('chat-messages');
    if (chatMessages) {
        chatMessages.innerHTML = '';
        showWelcomeMessage();
    }
    
    // Remove active class from all chat items
    document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // Update chat title
    const titleElement = document.getElementById('current-chat-title');
    if (titleElement) {
        titleElement.textContent = 'New Chat - AI Recommendation Chatbot';
    }
    
    // Focus on input
    const chatInput = document.getElementById('chat-input');
    if (chatInput) {
        chatInput.focus();
    }
    
    // Don't save to history yet - wait for first message
    console.log('New chat initialized with fresh context');
}

// Load a specific chat
function loadChat(chatId) {
    const chat = chatHistory.find(c => c.id === chatId);
    if (!chat) {
        console.error('Chat not found:', chatId);
        return;
    }
    
    console.log('Loading chat:', chatId, 'with', chat.messages.length, 'messages');
    
    // Switch to this chat's context
    currentChatId = chatId;
    
    const chatMessages = document.getElementById('chat-messages');
    if (!chatMessages) return;
    
    // Clear current messages
    chatMessages.innerHTML = '';
    
    // Show welcome message first
    showWelcomeMessage();
    
    // Load chat messages (skip welcome messages from history)
    chat.messages.forEach(message => {
        // Skip any messages that look like welcome messages
        if (message.content.includes('Hello! I\'m your AI-powered recommendation assistant')) {
            return;
        }
        addMessageToDOM(message.content, message.type === 'user', false);
    });
    
    // Update UI to show active chat
    document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.remove('active');
    });
    
    const currentChatElement = document.querySelector(`[onclick="loadChat('${chatId}')"]`);
    if (currentChatElement) {
        currentChatElement.classList.add('active');
    }
    
    // Update title
    const titleElement = document.getElementById('current-chat-title');
    if (titleElement) {
        titleElement.textContent = `${chat.title} - AI Recommendation Chatbot`;
    }
    
    // Focus on input
    const chatInput = document.getElementById('chat-input');
    if (chatInput) {
        chatInput.focus();
    }
    
    console.log('Chat loaded successfully. Current chat ID:', currentChatId);
}

// Clear all chats
function clearAllChats() {
    if (confirm('Are you sure you want to clear all chat history? This will permanently delete all conversations and their contexts.')) {
        console.log('Clearing all chats');
        
        // Delete all chats for current user
        const deletePromises = chatHistory.map(chat => 
            fetch("{% url 'recommendations:delete_chat' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    chat_id: chat.id
                })
            })
        );
        
        Promise.all(deletePromises)
        .then(responses => Promise.all(responses.map(r => r.json())))
        .then(results => {
            console.log('All chats cleared from database');
            chatHistory = [];
            startNewChat();
            updateChatHistoryDisplay();
            updateChatCount();
        })
        .catch(error => {
            console.error('Error clearing chats:', error);
            alert('Error clearing all chats. Please try again.');
        });
    }
}

// Update chat history display
function updateChatHistoryDisplay() {
    const historyList = document.getElementById('chat-history-list');
    if (!historyList) return;
    
    if (chatHistory.length === 0) {
        historyList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-comments"></i>
                <div>No chat history yet</div>
                <small>Start a conversation to see your chat history</small>
            </div>
        `;
        return;
    }
    
    historyList.innerHTML = chatHistory.map(chat => {
        const lastMessage = chat.messages[chat.messages.length - 1];
        const preview = lastMessage ? lastMessage.content.replace(/<[^>]*>/g, '').substring(0, 50) : 'New chat';
        const isActive = chat.id === currentChatId;
        
        return `
            <div class="chat-item ${isActive ? 'active' : ''}" onclick="loadChat('${chat.id}')">
                <div class="chat-name">
                    <span><i class="fas fa-comment"></i> ${chat.title}</span>
                    <button class="chat-delete-btn" onclick="event.stopPropagation(); deleteChat('${chat.id}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="chat-preview">
                    ${preview}${preview.length >= 50 ? '...' : ''}
                </div>
                <div class="chat-date">
                    <i class="fas fa-clock"></i>
                    ${new Date(chat.lastUpdated).toLocaleDateString()}
                </div>
            </div>
        `;
    }).join('');
}

// Update chat count
function updateChatCount() {
    const countBadge = document.getElementById('chat-count-badge');
    const countText = document.getElementById('chat-count');
    const clearBtn = document.getElementById('clear-chats-btn');
    
    if (countBadge) {
        countBadge.textContent = chatHistory.length;
    }
    
    if (countText) {
        countText.textContent = 
            chatHistory.length === 0 ? 'No chats yet' : `${chatHistory.length} chat${chatHistory.length > 1 ? 's' : ''}`;
    }
    
    if (clearBtn) {
        clearBtn.disabled = chatHistory.length === 0;
    }
}

// Filter chat history
function filterChatHistory(searchTerm) {
    const items = document.querySelectorAll('.chat-item');
    const term = searchTerm.toLowerCase();
    
    items.forEach(item => {
        const title = item.querySelector('.chat-name span').textContent.toLowerCase();
        const preview = item.querySelector('.chat-preview').textContent.toLowerCase();
        
        if (title.includes(term) || preview.includes(term)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

// =================== PURCHASE HISTORY FUNCTIONS ===================

// Load purchase history from API
function loadPurchaseHistory() {
    console.log('Loading purchase history...');
    
    // Show loading state
    showElement('purchase-loading');
    hideElement('purchase-summary');
    hideElement('purchase-controls');
    hideElement('purchase-table-container');
    hideElement('purchase-empty');
    hideElement('purchase-error');
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        showPurchaseError('Security token not found. Please refresh the page.');
        return;
    }
    
    fetch("{% url 'recommendations:get_purchase_history' %}", {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrfToken.value,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        hideElement('purchase-loading');
        
        if (data.status === 'success') {
            allPurchases = data.purchases;
            filteredPurchases = [...allPurchases];
            
            if (allPurchases.length === 0) {
                showElement('purchase-empty');
            } else {
                updatePurchaseSummary(data);
                displayPurchases();
                showElement('purchase-summary');
                showElement('purchase-controls');
                showElement('purchase-table-container');
            }
        } else {
            showPurchaseError(data.error || data.message || 'Failed to load purchase history');
        }
    })
    .catch(error => {
        console.error('Error loading purchase history:', error);
        hideElement('purchase-loading');
        showPurchaseError('Network error occurred while loading purchase history');
    });
}

// Update purchase summary cards
function updatePurchaseSummary(data) {
    document.getElementById('total-purchases').textContent = data.total_count.toLocaleString();
    document.getElementById('total-spent').textContent = `$${data.total_spent.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    document.getElementById('unique-products').textContent = data.unique_products.toLocaleString();
    document.getElementById('avg-order-value').textContent = `$${data.avg_order_value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
}

// Display purchases in table
function displayPurchases() {
    const tbody = document.getElementById('purchase-table-body');
    if (!tbody) return;
    
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const paginatedPurchases = filteredPurchases.slice(startIndex, endIndex);
    
    tbody.innerHTML = paginatedPurchases.map(purchase => `
        <tr class="purchase-item">
            <td>
                <span class="badge-invoice">${purchase.invoice_no}</span>
            </td>
            <td>
                <strong>${purchase.description}</strong>
            </td>
            <td>
                <span class="stock-code-badge">${purchase.stock_code}</span>
            </td>
            <td>
                <span class="fw-bold">${purchase.quantity}</span>
            </td>
            <td class="price-positive">
                $${purchase.unit_price.toFixed(2)}
            </td>
            <td class="price-positive">
                <strong>$${purchase.total_price.toFixed(2)}</strong>
            </td>
            <td>
                <div>
                    <strong>${purchase.purchase_datetime}</strong>
                </div>
            </td>
        </tr>
    `).join('');
    
    updatePagination();
}

// Filter purchases based on search input
function filterPurchases(searchTerm) {
    const term = searchTerm.toLowerCase().trim();
    
    if (!term) {
        filteredPurchases = [...allPurchases];
    } else {
        filteredPurchases = allPurchases.filter(purchase => 
            purchase.description.toLowerCase().includes(term) ||
            purchase.stock_code.toLowerCase().includes(term) ||
            purchase.invoice_no.toLowerCase().includes(term)
        );
    }
    
    currentPage = 1;
    displayPurchases();
}

// Sort purchases
function sortPurchases(sortBy) {
    switch (sortBy) {
        case 'date-desc':
            filteredPurchases.sort((a, b) => new Date(b.purchase_date + ' ' + b.purchase_time) - new Date(a.purchase_date + ' ' + a.purchase_time));
            break;
        case 'date-asc':
            filteredPurchases.sort((a, b) => new Date(a.purchase_date + ' ' + a.purchase_time) - new Date(b.purchase_date + ' ' + b.purchase_time));
            break;
        case 'price-desc':
            filteredPurchases.sort((a, b) => b.total_price - a.total_price);
            break;
        case 'price-asc':
            filteredPurchases.sort((a, b) => a.total_price - b.total_price);
            break;
        case 'qty-desc':
            filteredPurchases.sort((a, b) => b.quantity - a.quantity);
            break;
    }
    
    currentPage = 1;
    displayPurchases();
}

// Update pagination
function updatePagination() {
    const totalPages = Math.ceil(filteredPurchases.length / itemsPerPage);
    const pagination = document.getElementById('purchase-pagination');
    
    if (!pagination || totalPages <= 1) {
        if (pagination) pagination.innerHTML = '';
        return;
    }
    
    let paginationHTML = '';
    
    // Previous button
    paginationHTML += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>
        </li>
    `;
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            paginationHTML += `
                <li class="page-item ${currentPage === i ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                </li>
            `;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
    }
    
    // Next button
    paginationHTML += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>
        </li>
    `;
    
    pagination.innerHTML = paginationHTML;
}

// Change page
function changePage(page) {
    const totalPages = Math.ceil(filteredPurchases.length / itemsPerPage);
    if (page < 1 || page > totalPages) return;
    
    currentPage = page;
    displayPurchases();
}

// Export purchase history
function exportPurchaseHistory() {
    if (allPurchases.length === 0) {
        alert('No purchase data to export');
        return;
    }
    
    // Create CSV content
    const headers = ['Invoice', 'Stock Code', 'Product Description', 'Quantity', 'Unit Price', 'Total Price', 'Purchase Date', 'Purchase Time'];
    const csvContent = [
        headers.join(','),
        ...allPurchases.map(purchase => [
            purchase.invoice_no,
            purchase.stock_code,
            `"${purchase.description.replace(/"/g, '""')}"`, // Escape quotes
            purchase.quantity,
            purchase.unit_price,
            purchase.total_price,
            purchase.purchase_date,
            purchase.purchase_time
        ].join(','))
    ].join('\n');
    
    // Download file
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `purchase_history_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
}

// Show purchase error
function showPurchaseError(message) {
    document.getElementById('purchase-error-message').textContent = message;
    showElement('purchase-error');
}

// =================== UTILITY FUNCTIONS ===================

// Utility functions for showing/hiding elements
function showElement(id) {
    const element = document.getElementById(id);
    if (element) element.style.display = 'block';
}

function hideElement(id) {
    const element = document.getElementById(id);
    if (element) element.style.display = 'none';
}

// =================== GLOBAL FUNCTION EXPORTS ===================

// Make functions available globally for onclick handlers
window.startNewChat = startNewChat;
window.loadChat = loadChat;
window.deleteChat = deleteChat;
window.clearAllChats = clearAllChats;
window.changePage = changePage;
window.exportPurchaseHistory = exportPurchaseHistory;
window.loadPurchaseHistory = loadPurchaseHistory;
window.fillExampleQuery = fillExampleQuery;

</script>
{% endblock %}